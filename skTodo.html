<!DOCTYPE html>
<html>
<head>
	<link rel="stylesheet" href="../dijit/themes/claro/claro.css" />
    <meta charset="utf-8">
    <title>SkTodos</title>
</head>
<body class="claro">
	<div id="app"></div>
	<script src="https://apis.google.com/js/client.js"></script>
    <script data-dojo-config="async: 1, isDebug: 1"
            src="../dojo/dojo.js"></script>
    <script>
		require([
			"sktodos/MainComponent",
			"sktodos/models",
			'sktodos/GoogleJsonRest',
			"SkFramework/store/Sync",
			"dojo/on",
		], function(
			MainComponent,
			models,
			GoogleStore,
			Sync,
			on
		){
			gapi.client.setApiKey('AIzaSyCj1J8O-T61hBkTfMwYnvL9WZsbidbMLF8');
			gapi.auth.authorize({
				client_id: '9770186770',
				scope: 'https://www.googleapis.com/auth/tasks',
				immediate: true,
			}, function() {
				var token = gapi.auth.getToken();
				window.googleTasks = new GoogleStore({
					accessToken: token.access_token,
					target: "https://www.googleapis.com/tasks/v1/lists/MDc2NzE2NzUyNTMzMDAzNzE0MDM6MDow/tasks/",
					transformQueryResult: function(result) {
						return result.items.map(this.toInstance)
					},
					toInstance: function(object) {
						var params = {};
						Object.keys(object).forEach(function(key){
							switch(key){
								case "title": params.label = object[key]; break;
								default: params[key] = object[key];
							}							
						})
						return new Todo(params);
					},
					fromInstance: function(item){
						var object = {};
						Object.keys(item).forEach(function(key){
							switch(key){
								case "label": object.title = item[key]; break;
								default: object[key] = item[key];
							}							
						})
						return object;
					},

				});
				var todoStore = models.Todo.store;
				models.Todo.store = Sync(todoStore, googleTasks);
				
				var app = new MainComponent({
					models: models,
				}, "app");
				app.startup();
				models.Todo.store.sync();
				app.on("sync", function(){models.Todo.store.sync();});
				//new Tag({label:"test"}).save();
			});
		});
	</script>
</body>
</html>